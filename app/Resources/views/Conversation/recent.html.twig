{% extends "Conversation/layout.html.twig" %}

{% block content %}
        <h2>{{ 'conversation.recent'|trans({}, "conversations")|title }}</h2>

        <div class="cmsg_conversation">
        {% for message in messages %}
                {% include "Conversation/one_message.html.twig" with {"message":message} only %}
        {% endfor %}
        </div>


        <div id="replydialog" title="{{ 'message.reply.title'|trans({}, "conversations")|title }}">
                {% include "Conversation/syntax.html.twig" %}
        	{{ render(controller('BM2\\SiteBundle\\Controller\\ConversationController::replyRecentAction', { window: period })) }}
        </div>

{% endblock %}

{% block jquery %}

realmselect($("#realmsearch"), realmchange);
settlementselect($("#settlementsearch"), settlementchange);
charselect($("#charactersearch"), characterchange);

{% include "BM2SiteBundle:element:autocomplete.js.twig" %}

function search_insert(insert) {
	var caretPos = document.getElementById("message_reply_content").selectionStart;
	var textAreaTxt = $("#message_reply_content").val();
	$("#message_reply_content").val(textAreaTxt.substring(0, caretPos) + insert + textAreaTxt.substring(caretPos) );

}

function realmchange(id, name) {
	search_insert("[r:"+id+"]");
}
function settlementchange(id, name) {
	search_insert("[s:"+id+"]");
}
function characterchange(id, name) {
	search_insert("[c:"+id+"]");
}

$("#syntaxhelp").click(function(){
	$("#help").toggle();
});

$("#replydialog").dialog({
	autoOpen: false,
	width: "65%",
	position: { my: "center top", at: "center bottom", of: $("#symfony-header") }
});

$(".cmsg_conversation").on("click", "button.reply", function(){
	var id = $(this).closest('.cmsg_message').data('id');
        var conv = $(this).closest('.cmsg_message').data('conv');
        var local = $(this).closest('.cmsg_message').data('local');
	replyform("{{ 'message.reply.title'|trans({}, "conversations")|title }}", conv, id, local);
});

function replyform(title, conversation, reply_to, local) {
        $("#replydialog").dialog("option", "title", title);
        if (local) {
                
        } else {
                $("#message_reply_topic").parent().disabled();
                $("#message_reply_target").parent().disabled();
        }
	$("#replydialog").dialog("open");
	$("#recent_reply_conversation").val(conversation);
	$("#recent_reply_reply_to").val(reply_to);

	$("#replydialog form").attr('action', '{{ path('maf_conv_recent_reply', {window: period}) }}');
}

var request;
var target;

$("#oldmessages").hide();
var old_visible = false;
$("#hidetoggle").click(function(){
	if (old_visible) {
		$("#hidetoggle").html("{{ 'conversation.old.show'|trans({},"conversations") }}");
		$("#oldmessages").hide("blind", 1200);
		old_visible = false;
	} else {
		$("#hidetoggle").html("{{ 'conversation.old.hide'|trans({},"conversations") }}");
		$("#oldmessages").show("blind", 1200);
		old_visible = true;
	}
});
{% endblock %}
